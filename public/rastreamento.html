<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Rastreamento em Tempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: #f5f5f5;
    }
    #map {
      height: 100%;
    }
    #info {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      font-size: 14px;
      color: #333;
      z-index: 1000;
      text-align: center;
      min-width: 220px;
    }
    #centerBtn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transition: background 0.2s ease;
    }
    #centerBtn:hover {
      background: #0056b3;
    }
    @media (max-width: 600px) {
      #info {
        font-size: 13px;
        padding: 8px 12px;
      }
      #centerBtn {
        padding: 10px;
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div id="info">‚åõ Aguardando localiza√ß√£o...</div>
  <div id="map"></div>
  <button id="centerBtn" title="Centralizar mapa">üìç</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");
    if (!id) alert("ID de rastreamento n√£o informado.");

    // üó∫Ô∏è Camadas do mapa
    const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    });
    const cartoLight = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; <a href="https://carto.com/">Carto</a>',
      subdomains: 'abcd',
      maxZoom: 19
    });
    const cartoDark = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; <a href="https://carto.com/">Carto</a>',
      subdomains: 'abcd',
      maxZoom: 19
    });
    const satellite = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
      attribution: 'Tiles ¬© Esri'
    });

    const map = L.map("map", {
      center: [-8.05, -34.9],
      zoom: 13,
      layers: [osm]
    });

    const baseMaps = {
      "üåç OpenStreetMap": osm,
      "üßä Claro (Carto Light)": cartoLight,
      "üåô Escuro (Carto Dark)": cartoDark,
      "üõ∞Ô∏è Sat√©lite (Esri)": satellite
    };
    L.control.layers(baseMaps).addTo(map);

    function atualizarFiltro() {
      const tilePane = document.querySelector('.leaflet-tile-pane');
      if (!tilePane) return;
      const isDark = Object.values(map._layers).some(layer => layer._url && layer._url.includes('dark_all'));
      tilePane.style.filter = isDark ? 'brightness(4) contrast(1)' : 'none';
    }
    map.on('baselayerchange', atualizarFiltro);
    atualizarFiltro();

    const userIcon = L.icon({
      iconUrl: "/icon/location.gif",
      iconSize: [40, 40],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32],
    });

    const marker = L.marker([0, 0], { icon: userIcon }).addTo(map);
    const infoBox = document.getElementById("info");
    const centerBtn = document.getElementById("centerBtn");

    const dbUrl = `https://sos-comunidade-a98de-default-rtdb.firebaseio.com/rastreamento/${id}.json`;

    let lastLatLng = null;
    let ultimaHora = null;
    const pontos = [];
    let linha = null;
    let marcadorInicio = null;
    let marcadorFim = null;

    async function atualizar() {
      try {
        const res = await fetch(dbUrl);
        const data = await res.json();
        if (!data || typeof data !== 'object') {
          infoBox.innerText = "üîÑ Aguardando dados...";
          return;
        }

        const meta = data.meta || {};
        const entradas = Object.entries(data).filter(([k]) => k !== 'meta');
        if (entradas.length === 0) {
          infoBox.innerText = "üîÑ Nenhum ponto encontrado.";
          return;
        }

        entradas.sort((a, b) => a[1].timestamp - b[1].timestamp);
        const ultima = entradas[entradas.length - 1][1];
        const latlng = [ultima.latitude, ultima.longitude];

        marker.setLatLng(latlng).bindPopup("üìç Localiza√ß√£o atual").openPopup();

        if (!lastLatLng) map.setView(latlng, 16);
        else map.flyTo(latlng, 16, { animate: true, duration: 1.2 });

        lastLatLng = latlng;

        if (ultima.timestamp && ultima.timestamp !== ultimaHora) {
          ultimaHora = ultima.timestamp;
          const hora = new Date(ultima.timestamp).toLocaleTimeString();
          infoBox.innerText = `‚úÖ √öltima atualiza√ß√£o: ${hora}`;
        }

        pontos.length = 0;
        entradas.forEach(([, pos]) => {
          if (pos.latitude && pos.longitude) {
            pontos.push([pos.latitude, pos.longitude]);
          }
        });

        if (linha) map.removeLayer(linha);
        linha = L.polyline(pontos, { color: '#007bff', weight: 4 }).addTo(map);

        // ‚úÖ marcador de in√≠cio
        if (meta.localInicio && !marcadorInicio) {
          const inicioHora = meta.iniciadoEm ? new Date(meta.iniciadoEm).toLocaleTimeString() : '';
          marcadorInicio = L.marker([meta.localInicio.latitude, meta.localInicio.longitude]).addTo(map)
            .bindPopup(`üü¢ Iniciado √†s ${inicioHora}`).openPopup();
        }

        // ‚úÖ marcador de fim
        if (meta.finalizadoEm && !marcadorFim) {
          const fimHora = new Date(meta.finalizadoEm).toLocaleTimeString();
          marcadorFim = L.marker(latlng).addTo(map)
            .bindPopup(`üî¥ Finalizado √†s ${fimHora}`).openPopup();
        }

        console.log(`üîµ Trajeto com ${pontos.length} pontos atualizado.`);
      } catch (err) {
        console.error("Erro ao buscar localiza√ß√£o:", err);
        infoBox.innerText = "‚ö†Ô∏è Erro ao buscar localiza√ß√£o.";
      }
    }

    centerBtn.onclick = () => {
      if (lastLatLng) {
        map.flyTo(lastLatLng, 16, { animate: true, duration: 1.2 });
      }
    };

    setInterval(atualizar, 5000);
    atualizar();
  </script>
</body>
</html>
